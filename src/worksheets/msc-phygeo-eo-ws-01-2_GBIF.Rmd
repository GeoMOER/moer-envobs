tall.---
title: "msc-phygeo-eo-ws-01-1"
author: "MOC - Environmental Observations (F. Detsch, C. Reudenbach, T. Nauss)"
date: "30 März 2017"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
source("C:/Users/tnauss/permanent/edu/msc-phygeo-environmental-observation/scripts/msc-phygeo-environmental-observation/src/functions/set_environment.R")
```

## Get GBIF information
Get GBIF information on the distribution of relevant species. Subset the species occurence records to the area of Hessen. Create the final data frame using only those species which have at least 80 occurences. Transform projection to project projection EPSG 25832.
```{r}
prj <- sp::CRS("+init=epsg:25832")
prj_gbif <- sp::CRS("+init=epsg:4326")

hessen <- readRDS(paste0(path_rdata, "v_hessen.rds"))

species <- c("Somatochlora arctica", "Saxicola rubetra", "Myotis bechsteinii", "Corvus monedula", "Alcedo atthis", "Columba oenas", "Vanellus vanellus", "Onychogomphus forcipatus", "Barbastella barbastellus", "Milvus milvus", "Milvus migrans", "Dryocopus martius", "Ciconia ciconia", "Pernis apivorus")


soc <- lapply(species, function(s){
  print(s)
  info <- rgbif::occ_search(scientificName = s, country = "DE", hasCoordinate = TRUE)
  gbif <- data.frame(NAME = info$data$name,
                     LAT = info$data$decimalLatitude,
                     LON = info$data$decimalLongitude)
  # For Myotis bechsteinii, one observation is somewhere in Mongolia, remove it.
  gbif <- gbif[gbif$LON<=30, ]
  sp::coordinates(gbif) <- ~LON+LAT
  raster::projection(gbif) <- prj_gbif
  gbif <- sp::spTransform(gbif, prj)
  gbif <- gbif[which(rgeos::gIntersects(hessen, gbif, byid = TRUE)), ]
  return(gbif)
})
soc <- do.call("rbind", soc)
saveRDS(soc, paste0(path_rdata, "soc_org.rds"))
```

## Clean data
Remove duplicates
```{r}
soc_df <- as.data.frame(soc)
dpl <- duplicated(soc_df)
sum(dpl)
soc <- soc[!dpl,]
```

Include only those datasets which have at least 60 occurences.
```{r}
soc_nbr <- plyr::count(soc@data$NAME)
soc_nms <- soc_nbr$x[soc_nbr$freq >= 60]

soc <- soc[soc@data$NAME %in% soc_nms, ]
# mapview(soc, zcol = "NAME")

saveRDS(soc, paste0(path_rdata, "v_soc.rds"))
```
